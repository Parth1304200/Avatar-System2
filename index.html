<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Aptos Avatar DApp</title>
  <style>
    /* Dark theme base */
    body { 
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif; 
      max-width: 820px; 
      margin: 32px auto; 
      padding: 0 20px; 
      background: #0d1117; 
      color: #e6edf3; 
    }

    h1, h3 { 
      color: #f0f6fc; 
    }

    .card { 
      background: #161b22; 
      border: 1px solid #30363d; 
      padding: 20px; 
      border-radius: 12px; 
      box-shadow: 0 8px 24px rgba(0,0,0,0.3); 
      margin-top: 16px;
      transition: transform 0.2s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 28px rgba(0,0,0,0.45);
    }

    .row { display:flex; gap:10px; align-items:center; }

    input, button, textarea { 
      padding:10px 12px; 
      font-size:15px; 
      border-radius: 8px; 
      border: 1px solid #30363d; 
      background: #0d1117; 
      color: #e6edf3; 
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus { 
      border-color: #58a6ff; 
      box-shadow: 0 0 6px #1f6feb88; 
    }

    button { 
      background: linear-gradient(135deg, #238636, #2ea043);
      border: none;
      color: white;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    button:hover { 
      background: linear-gradient(135deg, #2ea043, #3fb950);
      transform: translateY(-1px);
    }
    button:active { transform: scale(0.98); }

    textarea { width:100%; min-height:60px; }

    img.avatar { 
      width:120px; 
      height:120px; 
      border-radius:12px; 
      object-fit:cover; 
      background:#30363d; 
      border: 2px solid #58a6ff;
    }

    #status { margin-top: 10px; font-size: 14px; color: #8b949e; }
    #resultName { font-weight:700; font-size: 18px; color:#f0f6fc; }
    #resultMeta { color:#8b949e; font-size:13px; }
  </style>
</head>
<body>
  <h1>üåô Aptos Avatar DApp</h1>

  <div class="card" id="walletCard">
    <div class="row">
      <button id="connectBtn">üîó Connect Wallet</button>
      <div id="addr" style="margin-left:8px; font-weight:600; color:#58a6ff"></div>
    </div>
  </div>

  <div class="card">
    <h3>Create / Update My Avatar</h3>
    <div>
      <label>Name</label><br/>
      <input id="name" placeholder="Your display name" />
    </div>
    <div style="margin-top:8px;">
      <label>Image URL (IPFS/HTTP)</label><br/>
      <input id="imgurl" placeholder="https://... or ipfs://..." />
    </div>
    <div style="margin-top:12px;" class="row">
      <button id="createBtn">‚ú® Create Avatar</button>
      <button id="updateBtn" style="background:linear-gradient(135deg,#8957e5,#a371f7);">‚ôª Update Avatar</button>
    </div>
    <div id="status"></div>
  </div>

  <div class="card">
    <h3>üîç Lookup Avatar by Address</h3>
    <div class="row">
      <input id="queryAddr" placeholder="0x..." style="flex:1" />
      <button id="lookupBtn" style="background:linear-gradient(135deg,#1f6feb,#58a6ff);">Lookup</button>
    </div>

    <div id="result" style="margin-top:14px; display:flex; gap:16px; align-items:center;">
      <img id="resultImg" class="avatar" src="" alt="avatar" />
      <div>
        <div id="resultName"></div>
        <div id="resultMeta"></div>
      </div>
    </div>
  </div>

  <script>
    // --- (JS stays the same as your current one) ---
    const MODULE_ADDRESS = "0xdea173ed001a4c1863d35ea52bd1cc60fa5459f8199b841c94835a6b53129274"; 
    const MODULE_NAME = "avatar";
    const NODE_URL = "https://fullnode.devnet.aptos.dev/v1"; 

    const connectBtn = document.getElementById('connectBtn');
    const addrDiv = document.getElementById('addr');
    const createBtn = document.getElementById('createBtn');
    const updateBtn = document.getElementById('updateBtn');
    const status = document.getElementById('status');
    const lookupBtn = document.getElementById('lookupBtn');

    let accountAddress = null;

    function toBytes(str) { return Array.from(new TextEncoder().encode(str)); }

    async function connectWallet() {
      if (!window.aptos) { alert("No Aptos wallet found. Install Petra."); return; }
      try {
        const res = await window.aptos.connect();
        accountAddress = res.address;
        addrDiv.innerText = accountAddress;
        status.innerText = "‚úÖ Wallet connected.";
      } catch (e) { status.innerText = "Wallet connect error: " + (e.message || e); }
    }

    async function sendEntryFunction(fnName, argsArray) {
      if (!window.aptos || !accountAddress) { alert("Connect a wallet first."); return; }
      const payload = {
        function: `${MODULE_ADDRESS}::${MODULE_NAME}::${fnName}`,
        type_arguments: [],
        arguments: argsArray
      };
      try {
        status.innerText = "‚úçÔ∏è Waiting for wallet signature...";
        const txRes = await window.aptos.signAndSubmitTransaction({ payload });
        status.innerText = "üöÄ Tx submitted: " + txRes.hash;
        return txRes.hash;
      } catch (err) {
        status.innerText = "‚ùå Tx error: " + (err.message || JSON.stringify(err));
        throw err;
      }
    }

    createBtn.onclick = async () => {
      const name = document.getElementById('name').value || "Anonymous";
      const url = document.getElementById('imgurl').value || "";
      await sendEntryFunction("create_avatar", [toBytes(name), toBytes(url)]);
    };

    updateBtn.onclick = async () => {
      const name = document.getElementById('name').value || "Anonymous";
      const url = document.getElementById('imgurl').value || "";
      await sendEntryFunction("update_avatar", [toBytes(name), toBytes(url)]);
    };

    lookupBtn.onclick = async () => {
      const owner = document.getElementById('queryAddr').value.trim();
      if (!owner) { alert("Enter an address"); return; }
      const resource_type = `${MODULE_ADDRESS}::${MODULE_NAME}::Avatar`;
      try {
        const res = await fetch(`${NODE_URL}/accounts/${owner}/resource/${encodeURIComponent(resource_type)}`);
        if (!res.ok) {
          document.getElementById('resultName').innerText = "No avatar found";
          document.getElementById('resultImg').src = "";
          document.getElementById('resultMeta').innerText = "";
          return;
        }
        const data = await res.json();
        const fields = data.data?.fields || data.data;
        const fromBytes = b => b ? new TextDecoder().decode(Uint8Array.from(b)) : "";
        const name = fromBytes(fields.name);
        const img = fromBytes(fields.image_url);
        document.getElementById('resultName').innerText = name || "(no name)";
        document.getElementById('resultImg').src = img || "";
        document.getElementById('resultMeta').innerText = `created: ${fields.created_at}, updated: ${fields.updated_at}`;
      } catch (e) {
        console.error(e); alert("Lookup failed: " + (e.message || e));
      }
    };

    connectBtn.onclick = connectWallet;
  </script>
</body>
</html>
